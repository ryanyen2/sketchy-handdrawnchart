<!DOCTYPE html>
<html>
  <head>
    <title>Auto Vega-Lite to Sketchy Converter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style>
    @font-face {
      font-family: 'xkcd';
      src: url('./Humor-Sans.ttf');
    }

    body {
      font-size: 16px;
      font-family: 'xkcd', sans-serif;
      padding: 20px;
      background-color: #f8f9fa;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .chart-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }
    
    .chart-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-style: italic;
    }
    
    h3 {
      margin-bottom: 20px;
      text-align: center;
      color: #444;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.1);
    }
    
    .control-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input[type="range"] {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .range-label {
      font-size: 12px;
      color: #666;
    }
    
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    path {
      fill: none;
      stroke-width: 1.5px;
    }
    
    .vega-embed details {
      display: none !important;
    }
    
    #loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="./js/d3.min.js"></script>
    <script type="text/javascript" src="./js/require.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Vega-Lite to Sketchy Converter</h1>
      <p class="subtitle">Transform any Vega-Lite bar chart into a hand-drawn sketchy version!</p>
      
      <div class="controls">
        <h4 style="margin-bottom: 15px; color: #333;">ðŸŽ¨ Sketchiness Controls</h4>
        
        <!-- Global Controls -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
          <div class="control-group">
            <label for="roughness">Global Roughness</label>
            <input type="range" id="roughness" min="0" max="2" step="0.1" value="0.8">
            <div class="range-label">0 (precise) - 2 (very sketchy)</div>
          </div>
          
          <div class="control-group">
            <label for="bowing">Global Bowing</label>
            <input type="range" id="bowing" min="0" max="2" step="0.1" value="0.8">
            <div class="range-label">0 (straight) - 2 (very curved)</div>
          </div>
          
          <div class="control-group" style="display: flex; align-items: flex-end;">
            <button onclick="regenerateSketchyChart()">ðŸ”„ Regenerate Chart</button>
          </div>
        </div>
        
        <!-- Element-specific Controls -->
        <h5 style="margin-bottom: 10px; color: #555;">Element Controls</h5>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
          <div class="control-group">
            <label>
              <input type="checkbox" id="sketchyBars" checked> Sketchy Bars
            </label>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="sketchyXAxis" checked> Sketchy X-Axis
            </label>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="sketchyYAxis" checked> Sketchy Y-Axis
            </label>
          </div>
          <div class="control-group">
            <label>
              <input type="checkbox" id="sketchyLabels" checked> Sketchy Labels
            </label>
          </div>
        </div>
        
        <!-- Individual Element Roughness -->
        <h5 style="margin-bottom: 10px; color: #555;">Individual Roughness</h5>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          <div class="control-group">
            <label for="barRoughness">Bar Roughness</label>
            <input type="range" id="barRoughness" min="0" max="3" step="0.1" value="0.8">
            <div class="range-label" id="barRoughness-val">0.8</div>
          </div>
          
          <div class="control-group">
            <label for="axisRoughness">Axis Roughness</label>
            <input type="range" id="axisRoughness" min="0" max="3" step="0.1" value="0.5">
            <div class="range-label" id="axisRoughness-val">0.5</div>
          </div>
          
          <div class="control-group">
            <label for="labelJitter">Label Jitter</label>
            <input type="range" id="labelJitter" min="0" max="5" step="0.5" value="1">
            <div class="range-label" id="labelJitter-val">1</div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-section">
          <h3>Original Vega-Lite Chart</h3>
          <div id="vis"></div>
        </div>
        
        <div class="chart-section">
          <h3>Sketchy Version</h3>
          <div id="sketchyVis">
            <div id="loading">Loading sketchy chart...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
    require(["./js/sketch"], function(ske) {
      
      // Extended dataset for more interesting visualization
      const data = [
        {"category": "Apples", "value": 85, "color": "#FF6B6B"},
        {"category": "Bananas", "value": 72, "color": "#4ECDC4"},
        {"category": "Cherries", "value": 63, "color": "#45B7D1"},
        {"category": "Dates", "value": 48, "color": "#96CEB4"},
        {"category": "Elderberries", "value": 35, "color": "#FECA57"},
        {"category": "Figs", "value": 28, "color": "#FF9FF3"},
        {"category": "Grapes", "value": 91, "color": "#54A0FF"},
        {"category": "Honeydew", "value": 67, "color": "#5F27CD"}
      ];

      // Enhanced Vega-Lite specification
      const vegaSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "description": "Fruit sales bar chart",
        "width": 400,
        "height": 300,
        "data": {
          "values": data
        },
        "mark": {
          "type": "bar",
          "tooltip": true,
          "cornerRadius": 2
        },
        "encoding": {
          "x": {
            "field": "category", 
            "type": "nominal",
            "axis": {
              "title": "Fruit Type",
              "labelAngle": -45
            }
          },
          "y": {
            "field": "value", 
            "type": "quantitative",
            "axis": {"title": "Sales (units)"},
            "scale": {"domain": [0, 100]}
          },
          "color": {
            "field": "color",
            "type": "nominal",
            "scale": null
          }
        }
      };

      let sketchyChart = null;

      // Render the original Vega-Lite chart
      vegaEmbed('#vis', vegaSpec, {actions: false}).then(function(result) {
        console.log("Vega-Lite chart rendered successfully");
        createSketchyChart();
      }).catch(console.error);

      function createSketchyChart() {
        const roughness = parseFloat(document.getElementById('roughness').value);
        const bowing = parseFloat(document.getElementById('bowing').value);
        
        // Get element-specific controls
        const sketchyBars = document.getElementById('sketchyBars').checked;
        const sketchyXAxis = document.getElementById('sketchyXAxis').checked;
        const sketchyYAxis = document.getElementById('sketchyYAxis').checked;
        const sketchyLabels = document.getElementById('sketchyLabels').checked;
        
        // Get individual roughness values
        const barRoughness = parseFloat(document.getElementById('barRoughness').value);
        const axisRoughness = parseFloat(document.getElementById('axisRoughness').value);
        const labelJitter = parseFloat(document.getElementById('labelJitter').value);
        
        // Clear previous sketchy chart
        d3.select("#sketchyVis").selectAll("*").remove();
        
        // Chart dimensions and margins
        const margin = {top: 20, right: 20, bottom: 80, left: 60};
        const width = 400 - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        // Create SVG for sketchy chart
        const svg = d3.select("#sketchyVis").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Create scales
        const xScale = d3.scale.ordinal()
            .domain(data.map(d => d.category))
            .rangeRoundBands([0, width], 0.1);

        const yScale = d3.scale.linear()
            .domain([0, 100])
            .range([height, 0]);

        // Create sketchy renderer with user-controlled parameters
        const sketch = new ske(roughness, bowing, svg, d3);
        const barSketch = new ske(barRoughness, bowing, svg, d3);
        const axisSketch = new ske(axisRoughness, bowing, svg, d3);

        // Draw bars (sketchy or regular)
        data.forEach((d, i) => {
          const barX = xScale(d.category);
          const barY = yScale(d.value);
          const barWidth = xScale.rangeBand();
          const barHeight = height - yScale(d.value);
          
          if (sketchyBars) {
            // Create sketchy rectangle
            const rectPrimitive = barSketch.rect(barX, barY, barWidth, barHeight);
            rectPrimitive.attr("stroke", d.color)
                        .attr("stroke-width", 2)
                        .attr("fill", "none");
          } else {
            // Create regular rectangle
            svg.append("rect")
               .attr("x", barX)
               .attr("y", barY)
               .attr("width", barWidth)
               .attr("height", barHeight)
               .attr("stroke", d.color)
               .attr("stroke-width", 2)
               .attr("fill", "none");
          }
        });

        // Draw sketchy axes and labels
        drawSketchyAxes(svg, axisSketch, xScale, yScale, width, height, data, {
          sketchyXAxis, sketchyYAxis, sketchyLabels, labelJitter
        });
        
        sketchyChart = {svg, sketch, barSketch, axisSketch, xScale, yScale, width, height};
      }

      function drawSketchyAxes(svg, sketch, xScale, yScale, width, height, data, options) {
        const {sketchyXAxis, sketchyYAxis, sketchyLabels, labelJitter} = options;
        
        // Draw Y-axis line
        if (sketchyYAxis) {
          sketch.line(0, 0, 0, height)
                .attr("stroke", "#333")
                .attr("stroke-width", 2);
        } else {
          svg.append("line")
             .attr("x1", 0).attr("y1", 0)
             .attr("x2", 0).attr("y2", height)
             .attr("stroke", "#333")
             .attr("stroke-width", 2);
        }

        // Draw X-axis line  
        if (sketchyXAxis) {
          sketch.line(0, height, width, height)
                .attr("stroke", "#333")
                .attr("stroke-width", 2);
        } else {
          svg.append("line")
             .attr("x1", 0).attr("y1", height)
             .attr("x2", width).attr("y2", height)
             .attr("stroke", "#333")
             .attr("stroke-width", 2);
        }

        // Add Y-axis ticks and labels
        const yTicks = [0, 20, 40, 60, 80, 100];
        yTicks.forEach(tick => {
          const y = yScale(tick);
          
          // Draw tick mark
          if (sketchyYAxis) {
            sketch.line(-5, y, 0, y)
                  .attr("stroke", "#333")
                  .attr("stroke-width", 1);
          } else {
            svg.append("line")
               .attr("x1", -5).attr("y1", y)
               .attr("x2", 0).attr("y2", y)
               .attr("stroke", "#333")
               .attr("stroke-width", 1);
          }
          
          // Add label with optional jitter
          const labelX = -10 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
          const labelY = y + 4 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
          
          svg.append("text")
             .attr("x", labelX)
             .attr("y", labelY)
             .attr("text-anchor", "end")
             .style("font-family", "xkcd, sans-serif")
             .style("font-size", "12px")
             .style("fill", "#333")
             .text(tick);
        });

        // Add X-axis labels
        data.forEach(d => {
          const x = xScale(d.category) + xScale.rangeBand() / 2;
          
          // Draw tick mark
          if (sketchyXAxis) {
            sketch.line(x, height, x, height + 5)
                  .attr("stroke", "#333")
                  .attr("stroke-width", 1);
          } else {
            svg.append("line")
               .attr("x1", x).attr("y1", height)
               .attr("x2", x).attr("y2", height + 5)
               .attr("stroke", "#333")
               .attr("stroke-width", 1);
          }
          
          // Add rotated label with optional jitter
          const labelX = x + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
          const labelY = height + 15 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
          const rotation = sketchyLabels ? -45 + (Math.random() - 0.5) * 10 : -45;
          
          svg.append("text")
             .attr("x", labelX)
             .attr("y", labelY)
             .attr("text-anchor", "end")
             .attr("transform", `rotate(${rotation}, ${labelX}, ${labelY})`)
             .style("font-family", "xkcd, sans-serif")
             .style("font-size", "11px")
             .style("fill", "#333")
             .text(d.category);
        });

        // Add axis titles with optional jitter
        const xTitleX = width / 2 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter * 2 : 0);
        const xTitleY = height + 65 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
        
        svg.append("text")
           .attr("x", xTitleX)
           .attr("y", xTitleY)
           .attr("text-anchor", "middle")
           .style("font-family", "xkcd, sans-serif")
           .style("font-size", "14px")
           .style("fill", "#333")
           .text("Fruit Type");

        const yTitleX = -height / 2 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter * 2 : 0);
        const yTitleY = -40 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
        
        svg.append("text")
           .attr("transform", `rotate(-90)`)
           .attr("x", yTitleX)
           .attr("y", yTitleY)
           .attr("text-anchor", "middle")
           .style("font-family", "xkcd, sans-serif")
           .style("font-size", "14px")
           .style("fill", "#333")
           .text("Sales (units)");

        // Add chart title with optional jitter
        const titleX = width / 2 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter * 2 : 0);
        const titleY = -5 + (sketchyLabels ? (Math.random() - 0.5) * labelJitter : 0);
        
        svg.append("text")
           .attr("x", titleX)
           .attr("y", titleY)
           .attr("text-anchor", "middle")
           .style("font-family", "xkcd, sans-serif")
           .style("font-size", "16px")
           .style("font-weight", "bold")
           .style("fill", "#333")
           .text("Fruit Sales - Customizable Sketchy Style");
      }

      // Global function for button
      window.regenerateSketchyChart = function() {
        if (sketchyChart) {
          createSketchyChart();
        }
      };

      // Add event listeners for real-time updates
      function setupEventListeners() {
        // Update range value displays
        document.getElementById('barRoughness').addEventListener('input', function() {
          document.getElementById('barRoughness-val').textContent = this.value;
          regenerateSketchyChart();
        });
        
        document.getElementById('axisRoughness').addEventListener('input', function() {
          document.getElementById('axisRoughness-val').textContent = this.value;
          regenerateSketchyChart();
        });
        
        document.getElementById('labelJitter').addEventListener('input', function() {
          document.getElementById('labelJitter-val').textContent = this.value;
          regenerateSketchyChart();
        });
        
        // Add checkbox listeners
        ['sketchyBars', 'sketchyXAxis', 'sketchyYAxis', 'sketchyLabels'].forEach(id => {
          document.getElementById(id).addEventListener('change', regenerateSketchyChart);
        });
        
        // Add global control listeners
        document.getElementById('roughness').addEventListener('input', regenerateSketchyChart);
        document.getElementById('bowing').addEventListener('input', regenerateSketchyChart);
      }

      // Initialize event listeners after DOM is ready
      setTimeout(setupEventListeners, 100);

    });
    </script>
  </body>
</html>
